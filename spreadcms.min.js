function render(e,t){var n=new XMLHttpRequest;n.open("GET",template+"?"+Math.floor(Math.random()*1e4));n.onreadystatechange=function(){if(n.readyState==4){if(n.status==200){var r=Hogan.compile(n.responseText);var i=Array();for(m in t.models){i.push({name:m})}context.models=i;for(var s=0;s<i.length;s++){context[i[s].name]={};context[i[s].name+"_list"]=e[i[s].name].elements;for(var o=0;o<e[i[s].name].elements.length;o++){context[i[s].name][o+1]=e[i[s].name].elements[o]}}if(id!==undefined){context.id=parseInt(id);context["item"]=context[model][id]}console.log(context);var u=r.render(context);document.open();document.write(u);document.close()}else{console.log("Could not find template: "+template);template="404.html"}}};n.send()}var template="";var context=Object();var model,id;var query="";var path=Array();var loc=window.location.pathname.split("/");for(var i=0;i<loc.length;i++){if(loc[i]!=""){path.push(loc[i])}}if(path.length==0){template="index.html"}else if(path.length==1){template="/"+path[0]+".html";model=path[0]}else if(path.length==2){template="/"+path[0]+"_detail.html";model=path[0];id=path[1]}else if(path.length==3){template="/"+path[0]+"_"+path[1]+".html";model=path[0];query=path[1]+" "+path[2]}(function(e){"use strict";if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e,t){if(this==null){throw new TypeError}var n=Object(this);var r=n.length>>>0;if(r===0){return-1}var i=0;if(arguments.length>1){i=Number(arguments[1]);if(i!=i){i=0}else if(i!=0&&i!=Infinity&&i!=-Infinity){i=(i>0||-1)*Math.floor(Math.abs(i))}}if(i>=r){return-1}var s=i>=0?i:Math.max(r-Math.abs(i),0);for(;s<r;s++){if(s in n&&n[s]===e){return s}}return-1}}var t=function(e){if(!this||!(this instanceof t)){return new t(e)}if(typeof e==="string"){e={key:e}}this.callback=e.callback;this.wanted=e.wanted||[];this.key=e.key;this.parseNumbers=!!e.parseNumbers;this.wait=!!e.wait;this.postProcess=e.postProcess;this.debug=!!e.debug;this.query=e.query||"";this.endpoint=e.endpoint||"https://spreadsheets.google.com";this.singleton=!!e.singleton;this.simple_url=!!e.simple_url;this.callbackContext=e.callbackContext;if(typeof e.proxy!=="undefined"){this.endpoint=e.proxy;this.simple_url=true;this.singleton=true}this.parameterize=e.parameterize||false;if(this.singleton){if(typeof t.singleton!=="undefined"){this.log("WARNING! Tabletop singleton already defined")}t.singleton=this}if(/key=/.test(this.key)){this.log("You passed a key as a URL! Attempting to parse.");this.key=this.key.match("key=(.*?)&")[1]}if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key);this.models={};this.model_names=[];this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=json-in-script";if(!this.wait){this.fetch()}};t.callbacks={};t.init=function(e){return new t(e)};t.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};t.prototype={fetch:function(e){if(typeof e!=="undefined"){this.callback=e}this.requestData(this.base_json_path,this.loadSheets)},requestData:function(e,t){this.injectScript(e,t)},injectScript:function(e,n){var r=document.createElement("script");var i;if(this.singleton){if(n===this.loadSheets){i="Tabletop.singleton.loadSheets"}else if(n===this.loadSheet){i="Tabletop.singleton.loadSheet"}}else{var s=this;i="tt"+ +(new Date)+Math.floor(Math.random()*1e5);t.callbacks[i]=function(){var e=Array.prototype.slice.call(arguments,0);n.apply(s,e);r.parentNode.removeChild(r);delete t.callbacks[i]};i="Tabletop.callbacks."+i}var o=e+"&callback="+i;if(this.simple_url){if(e.indexOf("/list/")!==-1){r.src=this.endpoint+"/"+this.key+"-"+e.split("/")[4]}else{r.src=this.endpoint+"/"+this.key}}else{r.src=this.endpoint+o}if(this.parameterize){r.src=this.parameterize+encodeURIComponent(r.src)}document.getElementsByTagName("script")[0].parentNode.appendChild(r)},isWanted:function(e){if(this.wanted.length===0){return true}else{return this.wanted.indexOf(e)!==-1}},data:function(){if(this.model_names.length===0){return undefined}return this.models},addWanted:function(e){if(this.wanted.indexOf(e)===-1){this.wanted.push(e)}},loadSheets:function(e){var t,n;var r=[];this.foundSheetNames=[];for(t=0,n=e.feed.entry.length;t<n;t++){this.foundSheetNames.push(e.feed.entry[t].title.$t);if(this.isWanted(e.feed.entry[t].content.$t)){var i=e.feed.entry[t].link[3].href.substr(e.feed.entry[t].link[3].href.length-3,3);var s="/feeds/list/"+this.key+"/"+i+"/public/values?sq="+this.query+"&alt=json-in-script";r.push(s)}}this.sheetsToLoad=r.length;for(t=0,n=r.length;t<n;t++){this.requestData(r[t],this.loadSheet)}},sheets:function(e){if(typeof e==="undefined"){return this.models}else{if(typeof this.models[e]==="undefined"){return}else{return this.models[e]}}},loadSheet:function(e){var n=new t.Model({data:e,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[n.name]=n;if(this.model_names.indexOf(n.name)===-1){this.model_names.push(n.name)}this.sheetsToLoad--;if(this.sheetsToLoad===0)this.doCallback()},doCallback:function(){if(this.sheetsToLoad===0){this.callback.apply(this.callbackContext||this,[this.data(),this])}},log:function(e){if(this.debug){if(typeof console!=="undefined"&&typeof console.log!=="undefined"){Function.prototype.apply.apply(console.log,[console,arguments])}}}};t.Model=function(e){var t,n,r,i;this.column_names=[];this.name=e.data.feed.title.$t;this.elements=[];this.raw=e.data;if(typeof e.data.feed.entry==="undefined"){e.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers");this.elements=[];return}for(var s in e.data.feed.entry[0]){if(/^gsx/.test(s))this.column_names.push(s.replace("gsx$",""))}for(t=0,r=e.data.feed.entry.length;t<r;t++){var o=e.data.feed.entry[t];var u={};for(var n=0,i=this.column_names.length;n<i;n++){var a=o["gsx$"+this.column_names[n]];if(typeof a!=="undefined"){if(e.parseNumbers&&a.$t!==""&&!isNaN(a.$t))u[this.column_names[n]]=+a.$t;else u[this.column_names[n]]=a.$t}else{u[this.column_names[n]]=""}}if(u.rowNumber===undefined)u.rowNumber=t+1;if(e.postProcess)e.postProcess(u);this.elements.push(u)}};t.Model.prototype={all:function(){return this.elements},toArray:function(){var e=[],t,n,r,i;for(t=0,r=this.elements.length;t<r;t++){var s=[];for(n=0,i=this.column_names.length;n<i;n++){s.push(this.elements[t][this.column_names[n]])}e.push(s)}return e}};e.Tabletop=t;console.log(template);t.init({key:key,query:query,callback:function(e,t){render(e,t)}})})(this)
